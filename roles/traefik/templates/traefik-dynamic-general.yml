# -*- mode: yaml; -*-
#
# General-purpose configuration (independent from back-ends)
# which Tr√¶fik insists should be dynamic

{% set _certs_vol = "^%s" % ( traefik_ssl_certs_location | default(traefik_tls_certs_location) | regex_escape ) %}
tls:
  stores:
    default:
      defaultCertificate:
        certFile: "{{ traefik_ssl_cert_path | default(traefik_tls_cert_path) | regex_replace(_certs_vol, '/etc/traefik/certs') }}"
        keyFile: "{{ traefik_ssl_key_path   | default(traefik_tls_key_path)  | regex_replace(_certs_vol, '/etc/traefik/certs') }}"

{% if traefik_debug %}
http:
  routers:
    debugonly-api:
      priority: {{ traefik_dashboard_rules_priority | default(0) }}
      entrypoints:
        - websecure
      rule: "PathPrefix(`/api`)"
      service: api@internal
    debugonly-dashboard:
      priority: {{ traefik_dashboard_rules_priority | default(0) }}
      entrypoints:
        - websecure
      rule: "PathPrefix(`/dashboard`)"
      service: dashboard@internal
      middlewares:
        - debugonly-dashboard-redirect
        - debugonly-dashboard-stripprefix
  middlewares:
    debugonly-dashboard-redirect:
      redirectRegex:
        regex: "(.*)/dashboard($|[?])"
        replacement: "${1}/dashboard/${2}"
        permanent: true
    debugonly-dashboard-stripprefix:
      stripPrefix:
        prefixes:
          - /dashboard/
          - /dashboard
{% endif %}
